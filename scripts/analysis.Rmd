---
title: "Ecological Sites of the UFO"
author: "steppe"
date: "2022-12-05"
output:
  pdf_document: default
  word_document: default
header-includes:
 - \usepackage[width=\textwidth]{caption}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

Ecological Sites are developed by the Natural Resource Conservation System (NRCS). Ecological Sites are models which aim to capture repeating motifs across the landscape. These motifs ....

ESD's are the successors to Range Manual thingies, and their development began in 1997.

ESD's were initially largely used in Arid Rangelands settings, and the status of their completion can be predicted by how well an area fits this description...

ESD's are completed along the USDA's Major Land Resource Areas.. Each MLRA is different, and so are most of their ES- but some have many attributes which carry across the MLRA borders....

In this report, and at the UFO in general, ESD's provide definitive references which we can compare land to. We can assess how our land is in relation to ESD's and these provide actionable decisions which allow the land to be managed with the Multiple use mandate and our RMP in mind...


```{r load libraries}
library(tidyverse)
library(PantaRhei)
library(grid) 
```

1) How many ES mapped to in UFO?
2) does the esd exist
3) does a state and transition model exist
4) does vegetation community production table exist. 
 a. which states
5) do quantitative benchmarks exist?

```{r import data}

pp <- '../data/processed'
f <- list.files(pp, pattern = 'csv')

transcription <- read.csv(file.path(pp, f[grep('Transcription', f)])) %>% 
  distinct(ECO.SITE, .keep_all = T) %>% 
  select(ECO.SITE:QUANTITATIVE.BENCHMARKS, -PLOTS) %>% 
  mutate(across(.cols = 2:4,  ~ if_else(.x == 'DONE', 1, 0)))

tracking <- read.csv(file.path(pp, f[grep('Tracking', f)]))
benchmarks <- read.csv(file.path(pp, f[grep('Quantitative', f)]))
production <- read.csv(file.path(pp, f[grep('Production', f)]))
stateTransition <- read.csv(file.path(pp, f[grep('Ordered', f )]))

rm(pp, f)
```



```{r collect quant values for writeup, echo = F}
tracking_vals <- tracking %>% filter(str_detect(PANEL, 'oversample', negate = T) & 
                                  ECO.SITE.MATCHED == TRUE) %>% 
  select(ECO.SITE) %>% 
  left_join(., transcription, by = 'ECO.SITE') 

# how many ES mapped to in UFO
tracking_vals %>% group_by(ECO.SITE) %>% count() # 38 are mapped to

# how many of these ESDS are completed ?
tracking_vals %>% 
  distinct(ECO.SITE, .keep_all = T) %>% 
  count(STATETRANSITION.PRODUCTION) # portions of at least 23 are complete. 

# how many of the plots do these represent
nrow(tracking_vals) # 155 base plots have ESDS

tracking %>% filter(str_detect(PANEL, 'oversample', negate = T), str_detect(STATUS, '^SAMPLED')) %>% nrow()
# 206 of the BASE Plots are completed

tracking %>% nrow()
# 279 plots were sampled

```



```{r fate of plots graph, echo = F}

base_plots <- tracking %>%
  filter(str_detect(PANEL, 'oversample', negate = T))

benchmarks <- benchmarks %>% 
  distinct(ECO.SITE) %>% 
  mutate(QUANTITATIVE.BENCHMARKS = 1)

op <- base_plots %>% 
  select(-PANEL, -PLOT.ID) %>% 
  left_join(., transcription, by = 'ECO.SITE') %>% 
  select(-QUANTITATIVE.BENCHMARKS) %>% 
  left_join(., benchmarks, by = 'ECO.SITE')  %>% 
  mutate(ECO.SITE.MATCHED = replace_na(ECO.SITE.MATCHED, FALSE),
         ECO.SITE.MATCHED = if_else(ECO.SITE.MATCHED == T, 1, 0),
         BASE.PLOTS = 1,
         STATUS = if_else(STATUS == 'SAMPLED', 1, 0)) %>% 
  mutate(across(STATETRANSITION.PRODUCTION:QUANTITATIVE.BENCHMARKS, ~ replace_na(.x, 0))) %>% 
  select(-ECO.SITE, SAMPLED = STATUS) %>% 
  colSums()

top <- sort(op, decreasing = T)
bottom = 255 - top 
names(bottom) <- NULL
names(top) <- NULL

#
loss <- vector(mode = "numeric", length = length(bottom))
for(i in seq(loss)) {loss[i] <-  bottom[i + 1] - bottom[i] }
loss <- loss[1:length(loss)-1]


is.even <- function(x) x %% 2 == 0
evenLETTERS <- LETTERS[is.even(1:26)]
oddLETTERS <- LETTERS[!is.even(1:26)]
evenLETTERS <- c('A', evenLETTERS) # deal with eccentricities involving A
evenLETTERS <- evenLETTERS[1:6]
oddLETTERS <- oddLETTERS[2:6]

from = sort(c(rep(evenLETTERS[1:length(evenLETTERS)-1], each = 2), 
              rep(oddLETTERS[1:length(oddLETTERS)-1], each = 1)))
to = sort( c('C', rep(oddLETTERS[2:length(oddLETTERS)], each = 2), 
             rep(evenLETTERS[2:length(evenLETTERS)], each = 1)))

top <- top[2:length(top)]
bottom <- bottom[2:(length(bottom)-1)]

quantity <- c(
  top[1], bottom[1], top[2], loss[1], bottom[1], 
  
  top[3], loss[3], bottom[2], top[4], loss[4], 
  
  bottom[3], top[5], loss[4], bottom[4]
)

#quantity = c(
# 206, # top[1] 
# 49, # bottom [1]
# 157, # top[2]
# 49, # loss[1]
# 49, # bottom[1]

# 122, # top[3]
# 35, # loss[3]
# 98,  # bottom[2]
# 115, # top[4]
# 7, # loss[4]
# 133, 
# 49,
# 66, 
# 140)
df = data.frame(from, to, quantity)

nodes <- data.frame(
  ID = LETTERS[1:11],
  label = c('Plots', 'Sampled', '', 'ES', '', 'ESD',  '',
          'Associated', '', 'Benchmarks', ''),
  x = c(1, rep(2:6, each = 2)),
  y = c(2, rep(c(2,1), times = 5)),
  label_pos = c('above', rep(c('above', 'below'), times = 5))
)

colors <- data.frame(substance = "<any>", color = "#008083")
ns <- list(type="arrow", gp=gpar(fill="#FD5901", col="white", lwd=4), mag_pos = 'label', mag_fmt="%.0f")
sankey(nodes, flows = df, node_style=ns, legend=F, colors, title = "Quantitative Benchmarks")

rm(colors, ns)
quantity
```



```{r}

```


