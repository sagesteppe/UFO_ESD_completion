---
title: "Increase Variation Around Narrow ESD Concepts"
author: NULL
date: NULL
output:
  pdf_document: default
  word_document: default
header-includes:
 - \usepackage[width=\textwidth]{caption}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

The quantitative benchmarks of ESDs are meant to capture the variation inherent in a state and phase under multiple conditions, from consecutive drought to surpluses of moisture, and under following multiple disturbances. They are intended to capture the variation that would be found in this state and phase combination across the geographic and climatic extents of the ESD in the relevant MLRA. 

Some of the Quantitative Benchmarks for Ecological Sites which we collected from ESD's were very narrow. In many of these instances the reported values were more narrow than the uncertainty of the estimates of the true value of the population gleaned from a single AIM plot. 

We seek to identify and broaden the estimates around these ESD's here. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```


```{r}
library(tidyverse)
```


```{r}
ppro <- '../data/processed'
f <- list.files(ppro, pattern = 'csv')

benchmarks <- read.csv(file.path(ppro, f[grep('Quantitative', f)])) %>% 
  filter(ECO.SITE != 'R042BB036NM')

rm(ppro, f)
```


Let's create 4 columns, forb - grass - shrub -tree, and then one panel for each with plot on the Y
```{r Dummy encode ranges of variation by Functional Group}

bm <- benchmarks %>% 
  mutate(RANGE = UPPER - LOWER, MEAN = (UPPER+LOWER)/2 )  %>% 
  pivot_longer(cols = LOWER:UPPER, names_to = 'ESTIMATE', values_to = 'COVER')  %>% 
  filter(!COVER_TYPE %in% c('LITTER', 'BAREGROUND'))

bm %>%  #  something like this should convey the idea of the lower left quad being off... 
  filter(MEAN >= 1) %>% 
  distinct(ECO.SITE, COVER_TYPE, .keep_all = T)  %>% 
  ggplot(aes(x = MEAN, y = RANGE, color = COVER_TYPE)) +
  geom_point() +
  
  geom_segment(aes(x =  0, y = 3, xend = 10, yend = 3), colour = "Black", lty = 2) +
  geom_segment(aes(x = 10, y = 4, xend = 20, yend = 4), colour = "Black", lty = 2) +
  geom_segment(aes(x = 20, y = 5, xend = 30, yend = 5), colour = "Black", lty = 2) +
  geom_segment(aes(x = 30, y = 6, xend = 50, yend = 6), colour = "Black", lty = 2) +

  geom_segment(aes(x = 10, y = 3, xend = 10, yend = 4), colour = "Black", lty = 2) +
  geom_segment(aes(x = 20, y = 4, xend = 20, yend = 5), colour = "Black", lty = 2) +
  geom_segment(aes(x = 30, y = 5, xend = 30, yend = 6), colour = "Black", lty = 2) +
  
  theme_bw()

rm(benchmarks)
```

Narrow ranges of variation were defined as 


   Mean        Range
---------    ----------
  < 10          < 3
10 -  20        < 4
20 -  30        < 5
30 -  50        < 6
50 - 100        < 7
   
   
```{r Plot Initial variation}

r3up <- bm %>%  #  something like this should convey the idea of the lower left quad being off... 
  filter(RANGE > 3, MEAN < 20) %>%  #
  distinct(ECO.SITE, COVER_TYPE, .keep_all = T) 
keep_ranges <- bm %>% 
  filter(MEAN > 20, RANGE > 5) %>% 
  bind_rows(r3up)

r3down <- bm %>%  
  filter(RANGE <= 3, MEAN < 20) %>%  
  distinct(ECO.SITE, COVER_TYPE, .keep_all = T) 
predict_data <- bm %>% 
  filter(MEAN > 20, RANGE <= 5) %>% 
  bind_rows(r3down)


keep_ranges %>% 
  ggplot(aes(x = MEAN, y = RANGE, color = COVER_TYPE)) +
  geom_point() +
  geom_smooth(method = 'lm') + # maybe grab the slope from here and do some dummy var for it...
  theme_bw()

summary(model)

bm %>% 
  ggplot() +
  geom_point(aes(x = COVER, y = ECO.SITE, color = ESTIMATE)) +
  facet_wrap( ~ COVER_TYPE, nrow = 1, scales = 'free_x') +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = 'Estimates of Ranges of Quantitative Benchmarks',
       y = 'Ecological Site', x = 'Fractional Cover')

rm(r3up, r3down)
```


```{r Model the Range of Variation for Estimates of Functional Group Covers}


anova( model <- lm(RANGE ~ MEAN + COVER_TYPE, data = keep_ranges) ) 
prediction <- predict(model, newdata = predict_data, interval = 'prediction', level = 0.8)
prediction <- cbind(predict_data, prediction)

predict(lm(RANGE ~ MEAN + COVER_TYPE, data = keep_ranges), keep_ranges, se.fit = TRUE) 
 
 
# 2. Regression line + confidence intervals

ggplot(prediction, aes(x = MEAN, y = fit, color = COVER_TYPE)) +
  geom_point() +
  stat_smooth(method = lm) +
  geom_line(aes(y = lwr), color = "red", linetype = "dashed")+
  geom_line(aes(y = upr), color = "red", linetype = "dashed")
```

